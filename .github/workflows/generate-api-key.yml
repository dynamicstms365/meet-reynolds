name: Generate API Key and Webhook Secret

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Username requesting the key'
        required: true
        type: string
      purpose:
        description: 'Purpose of the API key'
        required: true
        default: 'MCP Integration'
        type: choice
        options:
          - 'MCP Integration'
          - 'Webhook Testing'
          - 'Development'
          - 'Production'
      expires_days:
        description: 'Expiration in days'
        required: true
        default: '30'
        type: choice
        options:
          - '7'
          - '30'
          - '90'
          - '365'

jobs:
  generate-keys:
    runs-on: ubuntu-latest
    steps:
      - name: Generate API Key and Webhook Secret
        id: generate
        run: |
          # Generate unique API key
          API_KEY="github_copilot_$(date +%s)_$(openssl rand -hex 16)"
          
          # Generate webhook secret
          WEBHOOK_SECRET=$(openssl rand -hex 32)
          
          # Calculate expiration date
          EXPIRES_ON=$(date -d "+${{ github.event.inputs.expires_days }} days" '+%Y-%m-%d')
          
          # Create key metadata
          TIMESTAMP=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          
          echo "API_KEY=$API_KEY" >> $GITHUB_OUTPUT
          echo "WEBHOOK_SECRET=$WEBHOOK_SECRET" >> $GITHUB_OUTPUT
          echo "EXPIRES_ON=$EXPIRES_ON" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_OUTPUT
          
      - name: Store Key Information
        run: |
          # Create key record
          cat > api_key_${{ github.run_id }}.json << EOF
          {
            "api_key": "${{ steps.generate.outputs.API_KEY }}",
            "webhook_secret": "${{ steps.generate.outputs.WEBHOOK_SECRET }}",
            "username": "${{ github.event.inputs.username }}",
            "purpose": "${{ github.event.inputs.purpose }}",
            "created_at": "${{ steps.generate.outputs.TIMESTAMP }}",
            "expires_on": "${{ steps.generate.outputs.EXPIRES_ON }}",
            "status": "active",
            "endpoints": {
              "webhook_url": "https://github-copilot-bot.salmonisland-520555ec.eastus.azurecontainerapps.io/api/github/webhook",
              "health_check": "https://github-copilot-bot.salmonisland-520555ec.eastus.azurecontainerapps.io/api/github/health",
              "mcp_capabilities": "https://github-copilot-bot.salmonisland-520555ec.eastus.azurecontainerapps.io/mcp/capabilities",
              "mcp_sse": "https://github-copilot-bot.salmonisland-520555ec.eastus.azurecontainerapps.io/mcp/sse"
            }
          }
          EOF
          
          echo "📋 Key generated for: ${{ github.event.inputs.username }}"
          echo "🎯 Purpose: ${{ github.event.inputs.purpose }}"
          echo "📅 Expires: ${{ steps.generate.outputs.EXPIRES_ON }}"
          
      - name: Create Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # 🔑 API Key Generated Successfully
          
          ## Key Details
          | Field | Value |
          |-------|-------|
          | **Username** | \`${{ github.event.inputs.username }}\` |
          | **Purpose** | \`${{ github.event.inputs.purpose }}\` |
          | **Created** | \`${{ steps.generate.outputs.TIMESTAMP }}\` |
          | **Expires** | \`${{ steps.generate.outputs.EXPIRES_ON }}\` |
          | **Status** | \`Active\` |
          
          ## 🔐 Credentials
          > **Important**: Copy these credentials immediately. They will not be shown again.
          
          ### API Key
          \`\`\`
          ${{ steps.generate.outputs.API_KEY }}
          \`\`\`
          
          ### Webhook Secret
          \`\`\`
          ${{ steps.generate.outputs.WEBHOOK_SECRET }}
          \`\`\`
          
          ## 🔗 Endpoints
          | Service | URL |
          |---------|-----|
          | **Webhook** | \`https://github-copilot-bot.salmonisland-520555ec.eastus.azurecontainerapps.io/api/github/webhook\` |
          | **Health Check** | \`https://github-copilot-bot.salmonisland-520555ec.eastus.azurecontainerapps.io/api/github/health\` |
          | **MCP Capabilities** | \`https://github-copilot-bot.salmonisland-520555ec.eastus.azurecontainerapps.io/mcp/capabilities\` |
          | **MCP SSE Stream** | \`https://github-copilot-bot.salmonisland-520555ec.eastus.azurecontainerapps.io/mcp/sse\` |
          
          ## 🧪 Test Your Integration
          
          ### Test Health Endpoint
          \`\`\`bash
          curl -X GET "https://github-copilot-bot.salmonisland-520555ec.eastus.azurecontainerapps.io/api/github/health"
          \`\`\`
          
          ### Test MCP Capabilities
          \`\`\`bash
          curl -X GET "https://github-copilot-bot.salmonisland-520555ec.eastus.azurecontainerapps.io/mcp/capabilities" | jq '.tools[].name'
          \`\`\`
          
          ### Configure GitHub Webhook
          1. Go to your repository Settings → Webhooks
          2. Add webhook URL: \`https://github-copilot-bot.salmonisland-520555ec.eastus.azurecontainerapps.io/api/github/webhook\`
          3. Set content type: \`application/json\`
          4. Add secret: \`${{ steps.generate.outputs.WEBHOOK_SECRET }}\`
          5. Select events: \`Issues\`, \`Pull requests\`, \`Discussions\`
          
          ## 📚 Available MCP Tools
          - \`semantic_search\` - Search across repositories
          - \`create_discussion\` - Create GitHub discussions
          - \`create_issue\` - Create GitHub issues
          - \`add_comment\` - Add comments to discussions/issues
          - \`search_discussions\` - Search discussions specifically
          - \`search_issues\` - Search issues specifically
          - \`organization_discussions\` - Get org discussions
          - \`organization_issues\` - Get org issues
          - \`prompt_action\` - Natural language actions
          
          ## 🚨 Security Notes
          - Store credentials securely (use environment variables)
          - Do not commit credentials to repositories
          - Monitor usage and rotate keys regularly
          - Report any security issues immediately
          EOF
          
      - name: Upload Key Record
        uses: actions/upload-artifact@v4
        with:
          name: api-key-record-${{ github.run_id }}
          path: api_key_${{ github.run_id }}.json
          retention-days: 30