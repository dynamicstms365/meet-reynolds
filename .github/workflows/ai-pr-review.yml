name: AI PR Review Bot

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review (optional)'
        required: false
        type: string
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  ai_pr_review:
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.NGL_DEVOPS_APP_ID }}
          private-key: ${{ secrets.NGL_DEVOPS_BOT_PEM }}

      - name: Test Authentication
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          echo "Testing GitHub App authentication..."
          gh auth status
          gh api user
          echo "✅ Authentication successful!"

      - name: Find PR to Review
        id: find_pr
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
          INPUT_PR: ${{ github.event.inputs.pr_number || github.event.pull_request.number }}
        run: |
          if [[ -n "$INPUT_PR" ]]; then
            echo "pr_number=$INPUT_PR" >> $GITHUB_OUTPUT
            echo "Using specified PR: $INPUT_PR"
          else
            LATEST_PR=$(gh pr list --state open --limit 1 --json number --jq '.[0].number // empty')
            if [[ -n "$LATEST_PR" ]]; then
              echo "pr_number=$LATEST_PR" >> $GITHUB_OUTPUT
              echo "Found latest open PR: $LATEST_PR"
            else
              echo "No open PRs found"
              echo "pr_number=" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Review PR with Simple Test
        if: steps.find_pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
          PR_NUM: ${{ steps.find_pr.outputs.pr_number }}
        run: |
          echo "Reviewing PR #$PR_NUM..."
          
          # Get PR info
          PR_INFO=$(gh pr view $PR_NUM --json title,body,author,headRefName,baseRefName)
          TITLE=$(echo "$PR_INFO" | jq -r '.title')
          AUTHOR=$(echo "$PR_INFO" | jq -r '.author.login')
          
          # Simple automated review comment
          cat > review.md << EOF
          ## 🤖 Automated PR Review
          
          **PR**: $TITLE  
          **Author**: @$AUTHOR  
          **Reviewed by**: NGL DevOps Bot
          
          ✅ **Automated checks completed**
          - GitHub App authentication: Success
          - PR metadata extraction: Success
          - Bot permissions: Verified
          
          This is a test of the automated PR review system using GitHub App authentication.
          
          ---
          *Generated by NGL DevOps Bot with GitHub App ID: ${{ vars.NGL_DEVOPS_APP_ID }}*
          EOF
          
          # Post the review
          gh pr comment $PR_NUM --body-file review.md
          echo "✅ Posted review comment to PR #$PR_NUM"

      - name: Report Status
        if: steps.find_pr.outputs.pr_number == ''
        run: |
          echo "ℹ️  No PRs available to review. Create a PR and trigger this workflow again."
